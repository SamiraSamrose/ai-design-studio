<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Industrial Design Studio - Interactive Demo</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            line-height: 1.6;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        .header {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.15);
            margin-bottom: 30px;
            text-align: center;
        }

        .header h1 {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-size: 2.5rem;
            margin-bottom: 12px;
            font-weight: 700;
        }

        .subtitle {
            color: #555;
            font-size: 1.1rem;
            font-weight: 500;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
        }

        .panel {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
        }

        .control-panel {
            grid-column: 1;
            grid-row: 1 / 4;
        }

        .preview-panel {
            grid-column: 2;
            grid-row: 1;
        }

        .metadata-panel {
            grid-column: 2;
            grid-row: 2;
        }

        .workflow-panel {
            grid-column: 2;
            grid-row: 3;
        }

        .variants-panel, .comparison-panel {
            grid-column: 1 / 3;
            margin-top: 25px;
            display: none;
        }

        h2 {
            color: #667eea;
            margin-bottom: 25px;
            font-size: 1.75rem;
            border-bottom: 3px solid #667eea;
            padding-bottom: 12px;
            font-weight: 700;
        }

        h3 {
            color: #764ba2;
            margin-bottom: 15px;
            margin-top: 25px;
            font-size: 1.3rem;
            font-weight: 600;
        }

        .parameter-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #667eea;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #444;
            font-size: 0.95rem;
        }

        input[type="text"],
        input[type="number"],
        textarea,
        select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
            transition: all 0.3s;
            font-family: inherit;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        textarea {
            resize: vertical;
            min-height: 80px;
        }

        input[type="range"] {
            width: calc(100% - 70px);
            margin-right: 10px;
        }

        .slider-value {
            display: inline-block;
            min-width: 50px;
            text-align: right;
            font-weight: 600;
            color: #667eea;
            font-size: 0.95rem;
        }

        .color-palette-builder {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .color-input {
            width: 60px;
            height: 40px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            cursor: pointer;
        }

        .palette-preview {
            flex: 1;
            height: 40px;
            border-radius: 6px;
            border: 2px solid #e0e0e0;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 6px;
        }

        .checkbox-group input[type="checkbox"] {
            width: 20px;
            height: 20px;
            margin-right: 12px;
            cursor: pointer;
        }

        .json-preview-section {
            background: #1e1e1e;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
        }

        .json-preview-section h3 {
            color: #4fc3f7;
            margin-top: 0;
        }

        .json-display {
            background: #2d2d2d;
            border-radius: 6px;
            padding: 15px;
            max-height: 300px;
            overflow-y: auto;
        }

        .json-display pre {
            color: #a9b7c6;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            margin: 0;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .button-group {
            display: flex;
            gap: 12px;
            margin-top: 25px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 14px 28px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            flex: 1;
            min-width: 150px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 8px rgba(102, 126, 234, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
            color: white;
            box-shadow: 0 4px 8px rgba(118, 75, 162, 0.3);
        }

        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(118, 75, 162, 0.4);
        }

        .btn-tertiary {
            background: #e0e0e0;
            color: #333;
        }

        .btn-tertiary:hover {
            background: #d0d0d0;
        }

        .preview-container {
            min-height: 450px;
            background: linear-gradient(135deg, #f5f5f5 0%, #e0e0e0 100%);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            border: 2px dashed #ccc;
        }

        .preview-container canvas {
            max-width: 100%;
            max-height: 650px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .placeholder {
            text-align: center;
            color: #999;
            padding: 40px;
        }

        .metadata-container {
            background: #f9f9f9;
            padding: 20px;
            border-radius: 8px;
            font-size: 14px;
            border-left: 4px solid #764ba2;
        }

        .metadata-container p {
            margin-bottom: 10px;
            line-height: 1.8;
        }

        .metadata-container strong {
            color: #667eea;
        }

        .variants-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 25px;
            margin-bottom: 25px;
        }

        .variant-card {
            background: linear-gradient(135deg, #f9f9f9 0%, #ffffff 100%);
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            transition: all 0.3s;
            border: 3px solid transparent;
        }

        .variant-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
        }

        .variant-card.selected {
            border-color: #667eea;
            box-shadow: 0 8px 16px rgba(102, 126, 234, 0.4);
        }

        .variant-card canvas {
            width: 100%;
            height: 220px;
            display: block;
        }

        .variant-info {
            padding: 15px;
        }

        .variant-info p {
            margin: 6px 0;
            font-size: 13px;
            color: #555;
        }

        .comparison-container {
            display: flex;
            gap: 15px;
            overflow-x: auto;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .comparison-container canvas {
            max-height: 450px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            flex-shrink: 0;
        }

        .workflow-features {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .feature-card {
            background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
            padding: 25px;
            border-radius: 10px;
            border-left: 4px solid #667eea;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
        }

        .feature-card h3 {
            color: #667eea;
            margin-top: 0;
            margin-bottom: 12px;
            font-size: 1.2rem;
        }

        .feature-card p {
            color: #666;
            font-size: 0.95rem;
            line-height: 1.7;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .loading-overlay.active {
            display: flex;
        }

        .spinner {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #667eea;
            border-radius: 50%;
            width: 70px;
            height: 70px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-overlay p {
            color: white;
            margin-top: 25px;
            font-size: 1.3rem;
            font-weight: 600;
        }

        .loading-subtext {
            font-size: 1rem;
            color: #ccc;
            margin-top: 10px;
        }

        .consistency-report {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            display: none;
        }

        .consistency-report h3 {
            color: #856404;
            margin-top: 0;
        }

        .selection-indicator {
            background: #667eea;
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            margin-bottom: 15px;
            display: none;
            align-items: center;
            justify-content: space-between;
        }

        .selection-indicator.active {
            display: flex;
        }

        @media (max-width: 1200px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            .control-panel, .preview-panel, .metadata-panel, .workflow-panel {
                grid-column: 1;
                grid-row: auto;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>AI-Driven Industrial Product Design Studio</h1>
            <p class="subtitle">Generate photorealistic product designs with FIBO + ComfyUI + Nuke | HDR 16-bit Pipeline</p>
        </header>

        <main class="main-content">
            <section class="panel control-panel">
                <h2>Design Parameters</h2>
                
                <div class="form-group">
                    <label for="prompt">Product Description</label>
                    <textarea id="prompt" rows="3">Modern electric sedan with sleek aerodynamic body, LED headlights, and premium metallic finish</textarea>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="product_type">Product Type</label>
                        <select id="product_type">
                            <option value="car">Automotive</option>
                            <option value="electronics">Consumer Electronics</option>
                            <option value="appliance">Hardware/Appliance</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="api_provider">API Provider</label>
                        <select id="api_provider">
                            <option value="fal">FAL.AI (FIBO)</option>
                            <option value="bria">Bria.ai Direct</option>
                            <option value="replicate">Replicate</option>
                        </select>
                    </div>
                </div>

                <div class="parameter-section">
                    <h3>Fine-Grained Artistic Control</h3>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="camera_angle">Camera Angle</label>
                            <select id="camera_angle">
                                <option value="three_quarter">Three Quarter View</option>
                                <option value="front">Front View</option>
                                <option value="side">Side View</option>
                                <option value="isometric">Isometric View</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="lighting">Lighting</label>
                            <select id="lighting">
                                <option value="studio">Studio Lighting</option>
                                <option value="hdr">HDR Lighting</option>
                                <option value="dramatic">Dramatic Lighting</option>
                                <option value="natural">Natural Daylight</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="material">Material</label>
                            <select id="material">
                                <option value="metal">Metal</option>
                                <option value="plastic">Plastic</option>
                                <option value="glass">Glass</option>
                                <option value="carbon_fiber">Carbon Fiber</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="composition_focus">Composition</label>
                            <select id="composition_focus">
                                <option value="centered">Centered</option>
                                <option value="dynamic">Dynamic</option>
                                <option value="rule_of_thirds">Rule of Thirds</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="color_palette">Color Palette</label>
                        <div class="color-palette-builder">
                            <input type="color" id="color1" value="#1a1a1a" class="color-input">
                            <input type="color" id="color2" value="#ffffff" class="color-input">
                            <input type="color" id="color3" value="#c0c0c0" class="color-input">
                            <span class="palette-preview" id="palette_preview"></span>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="fov">Field of View</label>
                            <input type="range" id="fov" min="10" max="120" value="50" step="1">
                            <span id="fov_value" class="slider-value">50째</span>
                        </div>

                        <div class="form-group">
                            <label for="reflectivity">Reflections</label>
                            <input type="range" id="reflectivity" min="0" max="100" value="80" step="1">
                            <span id="reflectivity_value" class="slider-value">80%</span>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="texture_quality">Texture Quality</label>
                            <input type="range" id="texture_quality" min="0" max="100" value="90" step="1">
                            <span id="texture_quality_value" class="slider-value">90%</span>
                        </div>

                        <div class="form-group">
                            <label for="background">Background</label>
                            <select id="background">
                                <option value="studio_white">Studio White</option>
                                <option value="studio_black">Studio Black</option>
                                <option value="gradient">Gradient</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="parameter-section">
                    <h3>Output Configuration</h3>
                    
                    <div class="form-row">
                        <div class="form-group checkbox-group">
                            <input type="checkbox" id="hdr_enabled" checked>
                            <label for="hdr_enabled">Enable HDR (16-bit)</label>
                        </div>

                        <div class="form-group">
                            <label for="bit_depth">Bit Depth</label>
                            <select id="bit_depth">
                                <option value="8">8-bit</option>
                                <option value="16" selected>16-bit</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="json-preview-section">
                    <h3>JSON Parameters (Real-time)</h3>
                <div class="json-display">
                    <pre id="json_content">{}</pre>
                </div>
            </div>

            <div class="button-group">
                <button id="generate_btn" class="btn btn-primary">Generate Design</button>
                <button id="variants_btn" class="btn btn-secondary">Generate Variants</button>
                <button id="clear_btn" class="btn btn-tertiary">Clear</button>
            </div>
        </section>

        <section class="panel preview-panel">
            <h2>Design Preview</h2>
            <div id="preview_container" class="preview-container">
                <div class="placeholder">
                    <p>Production-quality visuals will appear here</p>
                    <p style="font-size: 0.9rem; color: #bbb; font-style: italic;">HDR + 16-bit fidelity</p>
                </div>
            </div>
            <div id="preview_controls" class="button-group" style="display: none;">
                <button id="refine_btn" class="btn btn-secondary">Refine (ComfyUI)</button>
                <button id="export_nuke_btn" class="btn btn-secondary">Export to Nuke</button>
                <button id="manufacturability_btn" class="btn btn-secondary">Check Manufacturability</button>
            </div>
        </section>

        <section class="panel metadata-panel">
            <h2>Design Metadata</h2>
            <div id="metadata_container" class="metadata-container">
                <p>No design generated yet. All parameters independently controllable with fine-grained artistic freedom.</p>
            </div>
        </section>

        <section class="panel workflow-panel">
            <h2>Enterprise Workflow</h2>
            <div class="workflow-features">
                <div class="feature-card">
                    <h3>JSON-Native Automation</h3>
                    <p>All parameters controllable via structured JSON with real-time updates across FIBO, ComfyUI, and Nuke workflows.</p>
                </div>
                <div class="feature-card">
                    <h3>Agentic Pipeline</h3>
                    <p>Multiple agents work in parallel performing consistency checks and optimizing for manufacturability.</p>
                </div>
                <div class="feature-card">
                    <h3>Professional Post-Production</h3>
                    <p>Nuke-ready nodes with HDR 16-bit finishing and JSON parameter preservation.</p>
                </div>
                <div class="feature-card">
                    <h3>Scalable AI Workflows</h3>
                    <p>Production-quality visuals without expensive photoshoots for automotive, electronics, and hardware.</p>
                </div>
            </div>
        </section>

        <section class="panel variants-panel" id="variants_panel">
            <h2>Design Variants - Parallel Agents</h2>
            <p style="color: #666; font-style: italic; margin-bottom: 20px;">Multiple agents generate assets simultaneously</p>
            
            <div class="selection-indicator" id="selection_indicator">
                <span id="selection_count">0 variants selected</span>
                <button id="clear_selection_btn" class="btn btn-tertiary" style="padding: 6px 12px; min-width: auto;">Clear Selection</button>
            </div>
            
            <div id="variants_container" class="variants-container"></div>
            <div id="consistency_report" class="consistency-report">
                <h3>Consistency Analysis</h3>
                <div id="consistency_content"></div>
            </div>
            <div class="button-group">
                <button id="compare_variants_btn" class="btn btn-secondary">Create Visual Comparison</button>
                <button id="select_best_btn" class="btn btn-secondary">AI Select Best</button>
            </div>
        </section>

        <section class="panel comparison-panel" id="comparison_panel">
            <h2>Visual Comparison Panel - HDR & 16-bit</h2>
            <p style="color: #666; font-style: italic; margin-bottom: 20px;">Side-by-side comparison with AI composition selection</p>
            <div id="comparison_container" class="comparison-container"></div>
        </section>
    </main>
</div>

<div class="loading-overlay" id="loading_overlay">
    <div class="spinner"></div>
    <p id="loading_text">Generating design...</p>
    <p id="loading_subtext" class="loading-subtext"></p>
</div>

<script>
    class DesignStudio {
        constructor() {
            this.currentDesign = null;
            this.variants = [];
            this.selectedVariants = [];
            this.initializeEventListeners();
            this.updateJSONPreview();
            this.updateColorPalette();
        }

        initializeEventListeners() {
            ['fov', 'reflectivity', 'texture_quality'].forEach(id => {
                document.getElementById(id).addEventListener('input', (e) => {
                    const suffix = id === 'fov' ? '째' : '%';
                    document.getElementById(`${id}_value`).textContent = `${e.target.value}${suffix}`;
                    this.updateJSONPreview();
                });
            });

            ['color1', 'color2', 'color3'].forEach(id => {
                document.getElementById(id).addEventListener('input', () => {
                    this.updateColorPalette();
                    this.updateJSONPreview();
                });
            });

            document.querySelectorAll('input, select, textarea').forEach(element => {
                element.addEventListener('change', () => this.updateJSONPreview());
            });

            document.getElementById('generate_btn').addEventListener('click', () => this.generateDesign());
            document.getElementById('variants_btn').addEventListener('click', () => this.generateVariants());
            document.getElementById('clear_btn').addEventListener('click', () => this.clearForm());
            document.getElementById('refine_btn').addEventListener('click', () => this.refineDesign());
            document.getElementById('export_nuke_btn').addEventListener('click', () => this.exportNuke());
            document.getElementById('manufacturability_btn').addEventListener('click', () => this.checkManufacturability());
            document.getElementById('compare_variants_btn').addEventListener('click', () => this.compareVariants());
            document.getElementById('select_best_btn').addEventListener('click', () => this.selectBest());
            document.getElementById('clear_selection_btn').addEventListener('click', () => this.clearSelection());
        }

        updateColorPalette() {
            const colors = [
                document.getElementById('color1').value,
                document.getElementById('color2').value,
                document.getElementById('color3').value
            ];
            document.getElementById('palette_preview').style.background = 
                `linear-gradient(to right, ${colors[0]} 0%, ${colors[0]} 33%, ${colors[1]} 33%, ${colors[1]} 66%, ${colors[2]} 66%, ${colors[2]} 100%)`;
        }

        getFormData() {
            return {
                prompt: document.getElementById('prompt').value,
                product_type: document.getElementById('product_type').value,
                api_provider: document.getElementById('api_provider').value,
                camera_angle: document.getElementById('camera_angle').value,
                lighting: document.getElementById('lighting').value,
                material: document.getElementById('material').value,
                composition_focus: document.getElementById('composition_focus').value,
                fov: parseFloat(document.getElementById('fov').value),
                reflectivity: parseFloat(document.getElementById('reflectivity').value) / 100,
                texture_quality: parseFloat(document.getElementById('texture_quality').value) / 100,
                color_palette: [
                    document.getElementById('color1').value,
                    document.getElementById('color2').value,
                    document.getElementById('color3').value
                ],
                background: document.getElementById('background').value,
                hdr_enabled: document.getElementById('hdr_enabled').checked,
                bit_depth: parseInt(document.getElementById('bit_depth').value)
            };
        }

        updateJSONPreview() {
            const formData = this.getFormData();
            document.getElementById('json_content').textContent = JSON.stringify(formData, null, 2);
        }

        showLoading(message, subtext = '') {
            const overlay = document.getElementById('loading_overlay');
            document.getElementById('loading_text').textContent = message;
            document.getElementById('loading_subtext').textContent = subtext;
            overlay.classList.add('active');
        }

        hideLoading() {
            document.getElementById('loading_overlay').classList.remove('active');
        }

        generateDesign() {
            const params = this.getFormData();
            this.showLoading('Generating design with FIBO...', 'JSON-native control for precise parameters');

            setTimeout(() => {
                const canvas = this.createDesignCanvas(params);
                const container = document.getElementById('preview_container');
                container.innerHTML = '';
                container.appendChild(canvas);
                
                this.currentDesign = {
                    canvas: canvas,
                    params: params,
                    id: 'design_' + Date.now()
                };

                document.getElementById('preview_controls').style.display = 'flex';
                this.displayMetadata(params);
                this.hideLoading();
                alert('Production-quality design generated with HDR 16-bit pipeline');
            }, 2000);
        }

        generateVariants() {
            const params = this.getFormData();
            this.showLoading('Generating variants with parallel agents...', 'Multiple agents generating simultaneously');

            setTimeout(() => {
                this.variants = [];
                this.selectedVariants = [];
                const angles = ['three_quarter', 'side', 'front', 'isometric'];
                const lightings = ['studio', 'hdr', 'dramatic'];
                
                for (let i = 0; i < 6; i++) {
                    const variantParams = {
                        ...params,
                        camera_angle: angles[i % angles.length],
                        lighting: lightings[i % lightings.length]
                    };
                    this.variants.push({
                        id: 'variant_' + i,
                        design_id: 'variant_' + Date.now() + '_' + i,
                        variant_id: 'variant_' + i,
                        params: variantParams,
                        canvas: this.createDesignCanvas(variantParams),
                        camera_angle: variantParams.camera_angle,
                        lighting: variantParams.lighting,
                        agent_id: 'agent_' + i
                    });
                }

                this.displayVariants();
                this.hideLoading();

                const consistency = Math.floor(85 + Math.random() * 10);
                document.getElementById('consistency_content').innerHTML = `
                    <p><strong>Total Designs:</strong> 6</p>
                    <p><strong>Successful:</strong> 6</p>
                    <p><strong>Failed:</strong> 0</p>
                    <p><strong>Consistency Score:</strong> ${consistency}%</p>
                `;
                document.getElementById('consistency_report').style.display = 'block';
                alert(`Generated 6 variants with ${consistency}% consistency. Click on variants to select them for comparison.`);
            }, 3000);
        }

        displayVariants() {
            const container = document.getElementById('variants_container');
            container.innerHTML = '';

            this.variants.forEach((variant, index) => {
                const card = document.createElement('div');
                card.className = 'variant-card';
                card.dataset.index = index;
                card.dataset.variantId = variant.design_id;

                const info = document.createElement('div');
                info.className = 'variant-info';
                info.innerHTML = `
                    <p><strong>ID:</strong> ${variant.variant_id}</p>
                    <p><strong>Camera:</strong> ${variant.camera_angle}</p>
                    <p><strong>Lighting:</strong> ${variant.lighting}</p>
                    <p><strong>Agent:</strong> ${variant.agent_id}</p>
                `;

                card.appendChild(variant.canvas.cloneNode(true));
                card.appendChild(info);

                card.addEventListener('click', () => {
                    const isSelected = card.classList.contains('selected');
                    
                    if (isSelected) {
                        card.classList.remove('selected');
                        this.selectedVariants = this.selectedVariants.filter(v => v.design_id !== variant.design_id);
                    } else {
                        card.classList.add('selected');
                        this.selectedVariants.push(variant);
                    }

                    this.updateSelectionIndicator();
                });

                container.appendChild(card);
            });

            document.getElementById('variants_panel').style.display = 'block';
            this.updateSelectionIndicator();
        }

        updateSelectionIndicator() {
            const indicator = document.getElementById('selection_indicator');
            const count = document.getElementById('selection_count');
            
            count.textContent = `${this.selectedVariants.length} variant${this.selectedVariants.length !== 1 ? 's' : ''} selected`;
            
            if (this.selectedVariants.length > 0) {
                indicator.classList.add('active');
            } else {
                indicator.classList.remove('active');
            }
        }

        clearSelection() {
            this.selectedVariants = [];
            document.querySelectorAll('.variant-card').forEach(card => {
                card.classList.remove('selected');
            });
            this.updateSelectionIndicator();
        }

        compareVariants() {
            if (this.selectedVariants.length < 2) {
                alert('Select at least 2 variants to compare.\n\nClick on variant cards to select them (they will have a blue border when selected).');
                return;
            }

            this.showLoading('Creating visual comparison panel...', 'Generating side-by-side comparison with HDR fidelity');

            setTimeout(() => {
                const container = document.getElementById('comparison_container');
                container.innerHTML = '';

                this.selectedVariants.forEach(variant => {
                    container.appendChild(variant.canvas.cloneNode(true));
                });

                document.getElementById('comparison_panel').style.display = 'block';
                this.hideLoading();
                
                document.getElementById('comparison_panel').scrollIntoView({ behavior: 'smooth', block: 'start' });
                
                alert(`Visual comparison panel created with ${this.selectedVariants.length} variants.\n\nNuke script generated and ready for professional compositing.`);
            }, 1500);
        }

        selectBest() {
            if (this.variants.length === 0) {
                alert('No variants to analyze');
                return;
            }

            this.showLoading('AI agent selecting best composition...', 'Analyzing quality metrics and composition rules');

            setTimeout(() => {
                const scores = this.variants.map((v, i) => ({
                    variant: v,
                    score: Math.floor(60 + Math.random() * 40)
                }));

                scores.sort((a, b) => b.score - a.score);
                const best = scores[0];

                let message = `AI Composition Selection:\n\n`;
                message += `Best Design: ${best.variant.variant_id}\n`;
                message += `Quality Score: ${best.score}/100\n\n`;
                message += `Reasoning:\n`;
                message += `Camera angle (${best.variant.camera_angle}) provides optimal visibility. `;
                message += `Lighting setup (${best.variant.lighting}) enhances material representation.\n\n`;
                message += `All Scores:\n`;
                scores.forEach(s => {
                    message += `${s.variant.variant_id}: ${s.score}/100\n`;
                });

                this.hideLoading();
                alert(message);
            }, 2000);
        }

        refineDesign() {
            if (!this.currentDesign) {
                alert('No design to refine');
                return;
            }

            const refinement = prompt('Enter refinement instructions:', 'Enhance details and increase sharpness');
            if (!refinement) return;

            this.showLoading('Refining design with ComfyUI nodes...', 'Iterative refinement workflow');

            setTimeout(() => {
                this.hideLoading();
                alert('Design refined successfully with ComfyUI');
            }, 2000);
        }

        exportNuke() {
            if (!this.currentDesign) {
                alert('No design to export');
                return;
            }

            this.showLoading('Generating Nuke script with HDR 16-bit workflow...', 'JSON-native control preserved');

            setTimeout(() => {
                const nukeScript = this.generateNukeScript(this.currentDesign.params);
                const blob = new Blob([nukeScript], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${this.currentDesign.id}_nuke_script.nk`;
                a.click();

                this.hideLoading();
                alert('Nuke script generated with professional HDR workflow.\n\nCompositors can tweak parameters while preserving JSON-native control.');
            }, 1500);
        }

        generateNukeScript(params) {
            return `#! Nuke Version 14.0
            AI-Driven Industrial Product Design Studio
Generated Nuke Script with JSON-Native Control
JSON Parameters:
${JSON.stringify(params, null, 2)}
Read {
inputs 0
file "${this.currentDesign.id}.png"
format "1024 1024 0 0 1024 1024 1 square_1K"
colorspace linear
name Read_Source
}
Colorspace {
colorspace_in linear
colorspace_out AlexaV3LogC
name ColorSpace_HDR
}
Grade {
white ${params.reflectivity}
gamma 1.0
black_clamp false
white_clamp false
name Grade_Reflectivity
label "JSON Control: reflectivity"
}
Sharpen {
size ${params.texture_quality * 10}
name Sharpen_Texture
label "JSON Control: texture_quality"
}
Write {
file "${this.currentDesign.id}_output.exr"
file_type exr
datatype "16 bit half"
compression "Zip (1 scanline)"
colorspace linear
name Write_EXR_16bit
}`;
}
checkManufacturability() {
            if (!this.currentDesign) {
                alert('No design to analyze');
                return;
            }

            this.showLoading('AI agent analyzing manufacturability...', 'Checking production feasibility');

            setTimeout(() => {
                const params = this.currentDesign.params;
                const complexity = Math.floor(5 + Math.random() * 4);
                
                let message = `Manufacturability Analysis:\n\n`;
                message += `Feasible: Yes\n`;
                message += `Complexity Score: ${complexity}/10\n`;
                message += `Estimated Cost Tier: medium\n`;
                message += `Manufacturing Methods: injection_molding, cnc_machining\n\n`;
                message += `Recommendations:\n`;
                
                if (params.product_type === 'car') {
                    message += `- Consider modular design approach for cost optimization\n`;
                    message += `- Validate aerodynamic properties in CFD simulation`;
                } else if (params.product_type === 'electronics') {
                    message += `- Ensure adequate ventilation for thermal management\n`;
                    message += `- Design for ease of assembly with minimal fasteners`;
                } else {
                    message += `- Optimize for standard manufacturing processes\n`;
                    message += `- Consider material availability and cost`;
                }

                this.hideLoading();
                alert(message);
            }, 2000);
        }

        displayMetadata(params) {
            const container = document.getElementById('metadata_container');
            let html = '';

            html += `<p><strong>Camera Angle:</strong> ${params.camera_angle.replace('_', ' ')}</p>`;
            html += `<p><strong>Field of View:</strong> ${params.fov}째</p>`;
            html += `<p><strong>Lighting:</strong> ${params.lighting}</p>`;
            html += `<p><strong>Material:</strong> ${params.material}</p>`;
            html += `<p><strong>Reflectivity:</strong> ${(params.reflectivity * 100).toFixed(0)}%</p>`;
            html += `<p><strong>Texture Quality:</strong> ${(params.texture_quality * 100).toFixed(0)}%</p>`;
            html += `<p><strong>Color Palette:</strong> ${params.color_palette.join(', ')}</p>`;
            html += `<p><strong>Composition:</strong> ${params.composition_focus.replace('_', ' ')}</p>`;
            html += `<p><strong>Background:</strong> ${params.background.replace('_', ' ')}</p>`;
            html += `<p><strong>HDR Enabled:</strong> ${params.hdr_enabled ? 'Yes' : 'No'}</p>`;
            html += `<p><strong>Bit Depth:</strong> ${params.bit_depth}-bit</p>`;
            html += `<p><strong>API Provider:</strong> ${params.api_provider.toUpperCase()}</p>`;

            container.innerHTML = html;
        }

        createDesignCanvas(params) {
            const canvas = document.createElement('canvas');
            canvas.width = 800;
            canvas.height = 600;
            const ctx = canvas.getContext('2d');

            const bgColor = params.background === 'studio_white' ? '#f5f5f5' : 
                           params.background === 'studio_black' ? '#1a1a1a' : 
                           '#e0e0e0';
            
            ctx.fillStyle = bgColor;
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            if (params.background === 'gradient') {
                const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
                gradient.addColorStop(0, params.color_palette[1]);
                gradient.addColorStop(1, params.color_palette[0]);
                ctx.fillStyle = gradient;
                ctx.fillRect(0, 0, canvas.width, canvas.height);
            }

            ctx.save();
            ctx.translate(canvas.width / 2, canvas.height / 2);

            const scale = params.fov / 50;
            const angle = params.camera_angle === 'front' ? 0 : 
                         params.camera_angle === 'side' ? Math.PI / 2 : 
                         params.camera_angle === 'three_quarter' ? Math.PI / 4 : 
                         Math.PI / 6;

            ctx.rotate(angle);

            if (params.product_type === 'car') {
                this.drawCar(ctx, params, scale);
            } else if (params.product_type === 'electronics') {
                this.drawElectronics(ctx, params, scale);
            } else {
                this.drawAppliance(ctx, params, scale);
            }

            ctx.restore();

            if (params.lighting === 'dramatic' || params.lighting === 'hdr') {
                ctx.fillStyle = 'rgba(255, 255, 255, 0.1)';
                ctx.beginPath();
                ctx.arc(canvas.width * 0.75, canvas.height * 0.25, 100, 0, Math.PI * 2);
                ctx.fill();
            }

            ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
            ctx.font = '12px monospace';
            ctx.fillText(`${params.api_provider.toUpperCase()} FIBO | HDR ${params.bit_depth}-bit`, 10, canvas.height - 10);

            return canvas;
        }

        drawCar(ctx, params, scale) {
            const baseColor = params.color_palette[0];
            const highlightColor = params.color_palette[1];
            const shadowColor = params.color_palette[2];

            ctx.fillStyle = baseColor;
            ctx.strokeStyle = shadowColor;
            ctx.lineWidth = 2;

            ctx.beginPath();
            ctx.moveTo(-150 * scale, 50 * scale);
            ctx.lineTo(-100 * scale, -30 * scale);
            ctx.lineTo(100 * scale, -30 * scale);
            ctx.lineTo(150 * scale, 50 * scale);
            ctx.closePath();
            ctx.fill();
            ctx.stroke();

            ctx.fillRect(-180 * scale, 50 * scale, 360 * scale, 40 * scale);

            if (params.reflectivity > 0.5) {
                const gradient = ctx.createLinearGradient(0, -30 * scale, 0, 50 * scale);
                gradient.addColorStop(0, highlightColor);
                gradient.addColorStop(1, baseColor);
                ctx.fillStyle = gradient;
                ctx.fillRect(-150 * scale, -30 * scale, 300 * scale, 80 * scale);
            }

            ctx.fillStyle = shadowColor;
            ctx.beginPath();
            ctx.arc(-100 * scale, 90 * scale, 25 * scale, 0, Math.PI * 2);
            ctx.fill();
            ctx.beginPath();
            ctx.arc(100 * scale, 90 * scale, 25 * scale, 0, Math.PI * 2);
            ctx.fill();

            if (params.material === 'glass') {
                ctx.fillStyle = 'rgba(135, 206, 250, 0.3)';
                ctx.fillRect(-80 * scale, -20 * scale, 160 * scale, 40 * scale);
            }
        }

        drawElectronics(ctx, params, scale) {
            const baseColor = params.color_palette[0];
            const accentColor = params.color_palette[2];

            ctx.fillStyle = baseColor;
            ctx.strokeStyle = accentColor;
            ctx.lineWidth = 3;

            ctx.fillRect(-120 * scale, -80 * scale, 240 * scale, 160 * scale);
            ctx.strokeRect(-120 * scale, -80 * scale, 240 * scale, 160 * scale);

            if (params.material === 'glass' || params.material === 'plastic') {
                ctx.fillStyle = 'rgba(200, 200, 200, 0.5)';
                ctx.fillRect(-100 * scale, -60 * scale, 200 * scale, 100 * scale);
            }

            ctx.fillStyle = accentColor;
            ctx.beginPath();
            ctx.arc(0, 40 * scale, 15 * scale, 0, Math.PI * 2);
            ctx.fill();

            if (params.reflectivity > 0.6) {
                ctx.fillStyle = 'rgba(255, 255, 255, 0.4)';
                ctx.fillRect(-110 * scale, -70 * scale, 100 * scale, 80 * scale);
            }
        }

        drawAppliance(ctx, params, scale) {
            const baseColor = params.color_palette[0];
            const detailColor = params.color_palette[2];

            ctx.fillStyle = baseColor;
            ctx.strokeStyle = detailColor;
            ctx.lineWidth = 2;

            ctx.fillRect(-100 * scale, -100 * scale, 200 * scale, 200 * scale);
            ctx.strokeRect(-100 * scale, -100 * scale, 200 * scale, 200 * scale);

            ctx.fillStyle = detailColor;
            ctx.beginPath();
            ctx.arc(0, 0, 60 * scale, 0, Math.PI * 2);
            ctx.fill();

            ctx.fillStyle = params.color_palette[1];
            ctx.beginPath();
            ctx.arc(0, 0, 50 * scale, 0, Math.PI * 2);
            ctx.fill();

            if (params.material === 'metal') {
                const gradient = ctx.createLinearGradient(-100 * scale, -100 * scale, 100 * scale, 100 * scale);
                gradient.addColorStop(0, baseColor);
                gradient.addColorStop(0.5, '#c0c0c0');
                gradient.addColorStop(1, baseColor);
                ctx.fillStyle = gradient;
                ctx.fillRect(-100 * scale, -100 * scale, 200 * scale, 200 * scale);
            }
        }

        clearForm() {
            document.getElementById('prompt').value = 'Modern electric sedan with sleek aerodynamic body, LED headlights, and premium metallic finish';
            document.getElementById('product_type').value = 'car';
            document.getElementById('api_provider').value = 'fal';
            document.getElementById('camera_angle').value = 'three_quarter';
            document.getElementById('lighting').value = 'studio';
            document.getElementById('material').value = 'metal';
            document.getElementById('composition_focus').value = 'centered';
            document.getElementById('fov').value = 50;
            document.getElementById('reflectivity').value = 80;
            document.getElementById('texture_quality').value = 90;
            document.getElementById('color1').value = '#1a1a1a';
            document.getElementById('color2').value = '#ffffff';
            document.getElementById('color3').value = '#c0c0c0';
            document.getElementById('background').value = 'studio_white';
            document.getElementById('hdr_enabled').checked = true;
            document.getElementById('bit_depth').value = '16';

            document.getElementById('fov_value').textContent = '50째';
            document.getElementById('reflectivity_value').textContent = '80%';
            document.getElementById('texture_quality_value').textContent = '90%';

            this.updateColorPalette();
            this.updateJSONPreview();
            alert('Parameters reset to defaults');
        }
    }

    const studio = new DesignStudio();
</script>
</body>
</html>